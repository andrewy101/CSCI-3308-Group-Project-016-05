<%- include ('../partials/head') %>
<%- include ('../partials/menu') %>



<main>


  <div class="col"><%- include ('../partials/message') %></div>
  
  <script>
    
    var month = "<%= data[0][0].curr_month %>";
    
    var month_str;
    var chartData = [];
  

    switch(month){
      case "01": month_str = "January"; break;
      case "02": month_str = "February"; break;
      case "03": month_str = "March"; break;
      case "04": month_str = "April"; break;
      case "05": month_str = "May"; break;
      case "06": month_str = "June"; break;
      case "07": month_str = "July"; break;
      case "08": month_str = "August"; break;
      case "09": month_str = "September"; break;
      case "10": month_str = "October"; break;
      case "11": month_str = "November"; break;
      case "12": month_str = "December"; break;
    }
    

    "<%for(let i = 0; i < data[0].length; ++i){%>"
      var operation = (parseInt("<%=data[0][i].total_amount_for_category%>") / parseInt("<%=data[1][0].monthlytotalspendings%>")) * 100;
      chartData.push({y: operation, label: "<%=data[0][i].category%>"});
    "<%}%>"
    

    console.log(chartData);
    
    window.onload = function() {
    var chart = new CanvasJS.Chart("chartContainer", {
      animationEnabled: true,
      title: {
        text: "Expense Overview for " + month_str
      },
      data: [{
        type: "pie",
        startAngle: 240,
        yValueFormatString: "##0.00\"%\"",
        indexLabel: "{label} {y}",
        options: {
          layout: {
            padding: -20
          }
        },
        dataPoints: chartData
      }]
    });
    chart.render();
    
    }
    </script>
    
  <div class="container" id="homepageContainer">
    
    <div class="row">
      <div class="col-sm">
        <div id="chartContainer"></div>
        <div id="month_form">
          <form action="/home" method="get">
            <div class="form-group">
              <label for="monthInput">View Expenses by Month</label>
              <input type="hidden" name="login" value="true">
              <input type="month" name="month" class="form-control" id="monthInput">
            </div>
            <button class="btn btn-primary" type="submit" style="margin-top:20px;">View Expenses</button>
          </form>
        </div>
      </div>
      <div class="col-sm">
        <h1 class="display-6" id="totalsTitle">Monthly Totals</h1>
        <ol class="list-group" style="width:500px;">
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold">Total Income</div>
              $<%= data[1][0].monthlytotalincome.toFixed(2) %>
            </div>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold">Total Spendings</div>
              $<%= data[1][0].monthlytotalspendings.toFixed(2) %>
            </div>
          </li>
        </ol>
        <h1 class="display-6" id="accordTitle">Categories</h1>
        
        <div class="accordion" id="accordionExample">
          <% data[0].forEach((category, index) => { %>
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading<%= index %>">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="true" aria-controls="collapse<%= index %>">
                  <%= category.category %>
                </button>
              </h2>
              <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                  <ol class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                      <div class="ms-2 me-auto">
                        <div class="fw-bold">Total Spendings for Category</div>
                        $<%= category.total_amount_for_category.toFixed(2) %>
                      </div>
                    
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                      <div class="ms-2 me-auto">
                        <div class="fw-bold">Total Income for Category</div>
                        $<%= category.total_income_for_category.toFixed(2) %>
                      </div>
                    
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                      <div class="ms-2 me-auto">
                        <div class="fw-bold">Amount Saved for Category Since Prior Month</div>
                          $<%=(category.total_amount_for_prior_month - category.total_amount_for_category).toFixed(2)%>
                      </div>
    
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                      <div class="ms-2 me-auto">
                        <div class="fw-bold">Budget Status for Category</div>
                        <% if (category.total_amount_for_category > category.budget_amount){%>
                          
                          Over Budget by $<%=(category.total_amount_for_category - category.budget_amount).toFixed(2)%>
                          
                        <%} else{%>
                          
                          Under Budget by $<%= (category.budget_amount - category.total_amount_for_category).toFixed(2)%>
                          
                        <%}%>
                    </div>
                  </li>
                </ol>
                <form action="/adjust_budget" method="post">

                  <div class="row g-3 align-items-center" style="margin-top:10px;">
                    <div class="col-auto">
                      <label for="inputPassword6" class="col-form-label">Adjust Budget</label>
                    </div>
                    <div class="col-auto">
                      <input type="number" name="budgetAdjustment" class="form-control"  placeholder="$<%=category.budget_amount%>">
                      <input type="hidden" name="category" value="<%=category.category%>">
                      <input type="hidden" name="month" value="<%=category.curr_month%>">
                    </div>
                    <div class="col-auto">
                      <button class="btn btn-primary" type="submit">Adjust</button>
                    </div>
                  </div>

                </form>
                
                </div>
              </div>
            </div>
          <% }) %>
        </div>
  
        
      </div>
      
    </div>

    
    
  </div>

  
    
  
  
</main>

<%- include ('../partials/footer') %>